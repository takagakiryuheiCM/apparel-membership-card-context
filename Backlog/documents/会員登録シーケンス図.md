# 会員アクティベートシーケンス図

## 概要

仮会員証発行から本会員証へのアクティベートまでの処理フローを記載します。

## シーケンス図

```mermaid
sequenceDiagram
    autonumber
    participant User as ユーザー
    participant App as LINEミニアプリ
    participant BE as バックエンド
    participant DB as DynamoDB
    participant POS as POS Gateway
    participant Staff as 店舗スタッフ

    %% 仮会員証発行フロー
    rect rgb(240, 248, 255)
        Note over User,Staff: 仮会員証発行フロー
        User->>App: 店舗選択・仮会員証発行ボタン押下
        App->>BE: POST /api/membership-cards
        BE->>POS: POST /members/temporary
        POS-->>BE: 仮会員ID、QRコード、有効期限
        BE->>DB: 仮会員証レコード作成（status=temporary）
        BE-->>App: 仮会員証情報
        App-->>User: QRコード表示（30分有効）
    end

    %% アクティベートフロー
    rect rgb(255, 248, 240)
        Note over User,Staff: 店舗でのアクティベートフロー
        User->>Staff: QRコード提示
        Staff->>POS: QRコードスキャン
        POS->>POS: 本会員番号発行
        POS->>BE: POST /webhook/member-activated
        BE->>DB: ステータス更新（status=active）
        BE->>App: LINE通知送信
        BE-->>POS: 200 OK
        App-->>User: 本会員証発行完了通知
    end

    %% 本会員証表示
    rect rgb(240, 255, 240)
        Note over User,Staff: 本会員証表示フロー
        User->>App: 会員証画面を開く
        App->>BE: GET /api/membership-cards/{cardId}
        BE->>DB: 会員証取得
        BE->>POS: GET /members/{memberId}/points
        POS-->>BE: ポイント情報
        BE-->>App: 会員証情報＋ポイント
        App-->>User: 本会員証・ポイント表示
    end
```

## 処理説明

### 1. 仮会員証発行フロー

1. ユーザーがLINEミニアプリで店舗を選択し、仮会員証発行ボタンを押下
2. バックエンドがPOS Gatewayに仮会員登録をリクエスト
3. POS Gatewayが仮会員IDとQRコードを発行（有効期限30分）
4. バックエンドがDynamoDBに仮会員証レコードを作成（status=temporary）
5. ユーザーにQRコードを表示

### 2. 店舗でのアクティベートフロー

1. ユーザーが店舗でQRコードを店舗スタッフに提示
2. 店舗スタッフがPOS端末でQRコードをスキャン
3. POSシステムが本会員番号を発行
4. POS GatewayがWebhookでバックエンドにアクティベート完了を通知
5. バックエンドがDynamoDBのステータスを更新（status=active）
6. ユーザーにLINE通知で本会員証発行完了を通知

### 3. 本会員証表示フロー

1. ユーザーが会員証画面を開く
2. バックエンドがDynamoDBから会員証情報を取得
3. バックエンドがPOS Gatewayからポイント情報をリアルタイム取得
4. ユーザーに本会員証とポイント情報を表示

## 例外処理

### 仮会員証有効期限切れ

```mermaid
sequenceDiagram
    participant User as ユーザー
    participant App as LINEミニアプリ
    participant BE as バックエンド
    participant DB as DynamoDB

    User->>App: 有効期限切れの仮会員証を表示
    App->>BE: GET /api/membership-cards/{cardId}
    BE->>DB: 会員証取得
    Note over BE: TTLにより削除済み or status確認
    BE-->>App: 404 Not Found or 有効期限切れエラー
    App-->>User: 「有効期限が切れました。再発行してください」
```

### POS接続エラー

```mermaid
sequenceDiagram
    participant App as LINEミニアプリ
    participant BE as バックエンド
    participant POS as POS Gateway

    App->>BE: POST /api/membership-cards
    BE->>POS: POST /members/temporary
    POS--xBE: タイムアウト（5秒）
    BE->>POS: リトライ1回目
    POS--xBE: タイムアウト
    BE->>POS: リトライ2回目
    POS--xBE: タイムアウト
    BE->>POS: リトライ3回目
    POS--xBE: タイムアウト
    BE-->>App: 503 Service Unavailable
    App-->>App: 「しばらく時間をおいて再度お試しください」
```
